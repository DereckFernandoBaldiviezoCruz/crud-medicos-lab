extends ../layout_admin

block content
  .container.mt-4
    h1.mb-4.text-primary Registrar nuevo horario

    form(method="POST" action="/admin/availabilities")
      .mb-3
        label.form-label Especialidad:
        select.form-select(name="specialtyId" id="specialtySelect" required)
          option(value="") Seleccione una especialidad
          each s in specialties
            option(value=s.id)= s.name

      .mb-3
        label.form-label Médico:
        select.form-select(name="medicId" id="medicSelect" required disabled)
          option(value="") Seleccione una especialidad primero

      .mb-3
        label.form-label Centro de Salud (automático):
        input.form-control(type="text" id="centerName" readonly)
        input(type="hidden" id="centerId" name="healthCenterId")

      .mb-3
        label.form-label Día de la semana:
        select.form-select(name="dayOfWeek" multiple size="5" required)
          option(value="1") Lunes
          option(value="2") Martes
          option(value="3") Miércoles
          option(value="4") Jueves
          option(value="5") Viernes

      .mb-3
        label.form-label Hora de inicio:
        input.form-control(type="time" name="startTime" required)

      .mb-3
        label.form-label Hora de fin:
        input.form-control(type="time" name="endTime" required)

      .mb-3
        label.form-label Duración de cita (minutos):
        input.form-control(type="number" name="durationMinutes" min="5" max="60" value="15" required)

      .mt-4
        button.btn.btn-primary(type="submit") Guardar

  script.
    const specialtySelect = document.getElementById("specialtySelect");
    const medicSelect = document.getElementById("medicSelect");
    const centerName = document.getElementById("centerName");
    const centerId = document.getElementById("centerId");

    specialtySelect.addEventListener("change", async () => {
      const id = specialtySelect.value;

      medicSelect.innerHTML = "";
      medicSelect.disabled = true;
      centerName.value = "";
      centerId.value = "";

      if (!id) return;

      const res = await fetch(`/admin/medics/by-specialty/${id}`);
      const medics = await res.json();

      medicSelect.disabled = false;
      medicSelect.innerHTML = `<option value="">Seleccione un médico</option>`;

      medics.forEach(m => {
        medicSelect.innerHTML += `
          <option value="${m.id}" data-center-id="${m.HealthCenter.id}" data-center-name="${m.HealthCenter.name}">
            ${m.User.fullname}
          </option>
        `;
      });
    });

    medicSelect.addEventListener("change", () => {
      const option = medicSelect.selectedOptions[0];
      if (!option) return;

      centerName.value = option.dataset.centerName;
      centerId.value = option.dataset.centerId;
    });
