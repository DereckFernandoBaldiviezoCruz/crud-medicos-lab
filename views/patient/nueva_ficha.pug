extends ./layout_patient

block content
  h1 Reserva de ficha

  // Datos del paciente arriba (layout ya los imprime)

  // SELECCIÓN DE ESPECIALIDAD
  h3 1. Seleccione la especialidad

  select#specialty(name="specialtyId" required)
    option(value="") -- Seleccione una opción --
    each esp in specialties
      option(value=esp.id)= esp.name

  br
  br

  // SELECCIÓN DE FECHA
  h3 2. Seleccione la fecha de atención

  label(for="fecha") Fecha:
  input#fecha(type="date" name="date" required)

  br
  br

  button#btnVerHorarios Ver horarios disponibles

  hr

  h3 Reglas del sistema
  ul
    li Solo puede sacar una ficha por día.
    li Si ya tiene ficha para hoy, no podrá reservar otra.
    li Los horarios que aparecen como “Ocupado” no están disponibles.

  // --- SCRIPT PARA VALIDAR FECHAS PERMITIDAS ---
  script.
    let fechasPermitidas = !{JSON.stringify(dates)}; 
    console.log("Fechas disponibles (original):", fechasPermitidas);
    
    // 1) Elimina duplicados y ORDENA las fechas ascendentemente
    fechasPermitidas = Array.from(new Set(fechasPermitidas)).sort();
    
    // 2) Min y max ya son realmente el primer y último día válidos
    const fechaInput = document.getElementById("fecha");
    const btn = document.getElementById("btnVerHorarios");
    
    fechaInput.min = fechasPermitidas[0];
    fechaInput.max = fechasPermitidas[fechasPermitidas.length - 1];
    
    console.log("Fechas disponibles (ordenadas):", fechasPermitidas);

    btn.addEventListener("click", () => {
      const fecha = fechaInput.value;
      const specialtyId = document.getElementById("specialty").value;

      if (!specialtyId) {
        alert("Debe seleccionar una especialidad.");
        return;
      }

      if (!fecha) {
        alert("Debe seleccionar una fecha.");
        return;
      }

      if (!fechasPermitidas.includes(fecha)) {
        alert("La fecha seleccionada NO está disponible.\nSolo puede seleccionar entre las fechas habilitadas.");
        return;
      }

      window.location.href = `/patient/horarios?date=${fecha}&specialtyId=${specialtyId}`;
    });
