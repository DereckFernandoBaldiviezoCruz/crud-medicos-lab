extends ./layout_patient

block content
  h1.text-primary.mb-4 Reserva de ficha

  link(rel="stylesheet", href="/css/reserva.css")

  style.
    /* Hover sobre días disponibles */
    .calendar td.disponible:hover {
      background-color: #cce5ff;
      cursor: pointer;
      transition: 0.2s;
    }

    /* Día seleccionado */
    .calendar td.seleccionado {
      background-color: #0d6efd !important;
      color: white !important;
      font-weight: bold;
      border-radius: 4px;
    }

    /* Fechas NO permitidas en rojo */
    .calendar td.no-disponible {
      background-color: #f8d7da !important;
      color: #842029 !important;
      cursor: not-allowed;
      opacity: 0.7;
    }

  h3 1. Seleccione la especialidad
  .mb-3
    select#specialty.form-select(name="specialtyId" required)
      option(value="") -- Seleccione una opción --
      each esp in specialties
        option(value=esp.id)= esp.name

  br

  h3 2. Seleccione la fecha de atención

  // Calendario dinámico
  #calendar-container

  br
  button#btnVerHorarios.btn.btn-primary.mt-3 Ver horarios disponibles

  hr

  h3 Reglas del sistema
  ul
    li Solo puede sacar una ficha por día.
    li Si ya tiene ficha para hoy, no podrá reservar otra.
    li Los horarios que aparecen como “Ocupado” no están disponibles.

  script.
    let fechasPermitidas = !{JSON.stringify(dates)};
    fechasPermitidas = Array.from(new Set(fechasPermitidas)).sort();

    const btn = document.getElementById("btnVerHorarios");
    const calendarContainer = document.getElementById("calendar-container");
    let fechaSeleccionada = null;

    function generarCalendario() {
      const hoy = new Date();
      const year = hoy.getFullYear();
      const month = hoy.getMonth();

      const primerDia = new Date(year, month, 1);
      const ultimoDia = new Date(year, month + 1, 0);

      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

      let html = '<table class="table table-bordered text-center calendar"><thead><tr>';
      diasSemana.forEach(d => html += `<th>${d}</th>`);
      html += '</tr></thead><tbody><tr>';

      for (let i = 0; i < primerDia.getDay(); i++) html += '<td></td>';

      for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const fecha = `${year}-${String(month+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;

        const disponible = fechasPermitidas.includes(fecha);

        html += `<td class="dia ${disponible ? 'disponible' : 'no-disponible'}" data-fecha="${fecha}">${dia}</td>`;

        if ((primerDia.getDay() + dia) % 7 === 0) html += '</tr><tr>';
      }

      html += '</tr></tbody></table>';
      calendarContainer.innerHTML = html;

      document.querySelectorAll('.dia.disponible').forEach(celda => {
        celda.addEventListener('click', () => {
          document.querySelectorAll('.seleccionado').forEach(el => el.classList.remove('seleccionado'));
          celda.classList.add('seleccionado');
          fechaSeleccionada = celda.dataset.fecha;
        });
      });
    }

    generarCalendario();

    btn.addEventListener('click', () => {
      const specialtyId = document.getElementById('specialty').value;

      if (!specialtyId) {
        alert('Debe seleccionar una especialidad.');
        return;
      }

      if (!fechaSeleccionada) {
        alert('Debe seleccionar una fecha del calendario.');
        return;
      }

      window.location.href = `/patient/horarios?date=${fechaSeleccionada}&specialtyId=${specialtyId}`;
    });
